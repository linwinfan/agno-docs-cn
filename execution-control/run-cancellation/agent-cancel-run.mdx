---
title: "智能体运行取消"
sidebarTitle: 取消智能体运行
description: 学习如何通过在单独线程中启动智能体运行并从另一个线程取消它来取消正在运行的智能体执行。
keywords: [智能体运行取消, 取消智能体运行, 取消智能体运行示例]
---

此示例演示如何通过在单独线程中启动智能体运行并从另一个线程取消它来取消正在运行的智能体执行。它展示了正确处理已取消响应和线程管理。

## 示例

```python agent_cancel_run.py
"""
演示如何取消正在运行的智能体执行的示例。

此示例展示如何：
1. 在单独线程中启动智能体运行
2. 从另一个线程取消运行
3. 处理已取消的响应
"""

import threading
import time

from agno.agent import Agent
from agno.models.openai import OpenAIChat
from agno.run.agent import RunEvent
from agno.run.base import RunStatus


def long_running_task(agent: Agent, run_id_container: dict):
    """
    模拟可以取消的长时间运行的智能体任务。

    Args:
        agent: 要运行的智能体
        run_id_container: 用于存储 run_id 以便取消的字典

    Returns:
        包含运行结果和状态的字典
    """
    # 启动智能体运行 - 这模拟一个长任务
    final_response = None
    content_pieces = []

    for chunk in agent.run(
        "写一个关于学习编程的龙的非常长的故事。"
        "使其至少 2000 字，包含详细描述和对话。"
        "慢慢来，要非常详尽。",
        stream=True,
    ):
        if "run_id" not in run_id_container and chunk.run_id:
            run_id_container["run_id"] = chunk.run_id

        if chunk.event == RunEvent.run_content:
            print(chunk.content, end="", flush=True)
            content_pieces.append(chunk.content)
        # 当运行被取消时，会发出 `RunEvent.run_cancelled` 事件
        elif chunk.event == RunEvent.run_cancelled:
            print(f"\n运行被取消: {chunk.run_id}")
            run_id_container["result"] = {
                "status": "cancelled",
                "run_id": chunk.run_id,
                "cancelled": True,
                "content": "".join(content_pieces)[:200] + "..."
                if content_pieces
                else "取消前无内容",
            }
            return
        elif hasattr(chunk, "status") and chunk.status == RunStatus.completed:
            final_response = chunk

    # 如果我们到达这里，运行已成功完成
    if final_response:
        run_id_container["result"] = {
            "status": final_response.status.value
            if final_response.status
            else "completed",
            "run_id": final_response.run_id,
            "cancelled": final_response.status == RunStatus.cancelled,
            "content": ("".join(content_pieces)[:200] + "...")
            if content_pieces
            else "无内容",
        }
    else:
        run_id_container["result"] = {
            "status": "unknown",
            "run_id": run_id_container.get("run_id"),
            "cancelled": False,
            "content": ("".join(content_pieces)[:200] + "...")
            if content_pieces
            else "无内容",
        }


def cancel_after_delay(agent: Agent, run_id_container: dict, delay_seconds: int = 3):
    """
    在指定延迟后取消智能体运行。

    Args:
        agent: 应该取消其运行的智能体
        run_id_container: 包含要取消的 run_id 的字典
        delay_seconds: 取消前等待多长时间
    """
    print(f"将在 {delay_seconds} 秒后取消运行...")
    time.sleep(delay_seconds)

    run_id = run_id_container.get("run_id")
    if run_id:
        print(f"正在取消运行: {run_id}")
        success = agent.cancel_run(run_id)
        if success:
            print(f"运行 {run_id} 已标记为取消")
        else:
            print(
                f"取消运行 {run_id} 失败（可能不存在或已完成）"
            )
    else:
        print("未找到要取消的 run_id")


def main():
    """演示智能体运行取消的主函数。"""

    # 使用模型初始化智能体
    agent = Agent(
        name="StorytellerAgent",
        model=OpenAIChat(id="gpt-5-mini"),  # 使用可以生成长响应的模型
        description="一个写详细故事的智能体",
    )

    print("启动智能体运行取消示例...")
    print("=" * 50)

    # 在线程间共享 run_id 的容器
    run_id_container = {}

    # 在单独线程中启动智能体运行
    agent_thread = threading.Thread(
        target=lambda: long_running_task(agent, run_id_container), name="AgentRunThread"
    )

    # 启动取消线程
    cancel_thread = threading.Thread(
        target=cancel_after_delay,
        args=(agent, run_id_container, 8),  # 8 秒后取消
        name="CancelThread",
    )

    # 启动两个线程
    print("启动智能体运行线程...")
    agent_thread.start()

    print("启动取消线程...")
    cancel_thread.start()

    # 等待两个线程完成
    print("等待线程完成...")
    agent_thread.join()
    cancel_thread.join()

    # 打印结果
    print("\n" + "=" * 50)
    print("结果:")
    print("=" * 50)

    result = run_id_container.get("result")
    if result:
        print(f"状态: {result['status']}")
        print(f"运行 ID: {result['run_id']}")
        print(f"是否被取消: {result['cancelled']}")

        if result.get("error"):
            print(f"错误: {result['error']}")
        else:
            print(f"内容预览: {result['content']}")

        if result["cancelled"]:
            print("\n成功: 运行已成功取消！")
        else:
            print("\n警告: 运行在取消前已完成")
    else:
        print("未获得结果 - 检查取消是否在流式传输期间发生")

    print("\n示例完成！")


if __name__ == "__main__":
    # 运行主示例
    main()
```

## API 端点

可以通过 AgentOS API 取消智能体运行：

```bash
POST /agents/{agent_id}/runs/{run_id}/cancel
```

**示例：**
```bash
curl --location 'http://localhost:7777/agents/story-writer-agent/runs/123/cancel' \
  --request POST
```

**参考：**[取消智能体运行 API](/reference-api/schema/agents/cancel-agent-run)

