---
title: "团队运行取消"
sidebarTitle: 取消团队运行
description: 学习如何通过在单独线程中启动团队运行并从另一个线程取消它来取消正在运行的团队执行。
keywords: [团队运行取消, 取消团队运行, 取消团队运行示例]
---

此示例演示如何通过在单独线程中启动团队运行并从另一个线程取消它来取消正在运行的团队执行。它展示了正确处理已取消响应和线程管理。

## 示例

```python team_cancel_run.py
"""
演示如何取消正在运行的团队执行的示例。

此示例展示如何：
1. 在单独线程中启动团队运行
2. 从另一个线程取消运行
3. 处理已取消的响应
"""

import threading
import time

from agno.agent import Agent
from agno.models.openai import OpenAIChat
from agno.run.agent import RunEvent
from agno.run.base import RunStatus
from agno.run.team import TeamRunEvent
from agno.team import Team


def long_running_task(team: Team, run_id_container: dict):
    """
    模拟可以取消的长时间运行的团队任务。

    Args:
        team: 要运行的团队
        run_id_container: 用于存储 run_id 以便取消的字典

    Returns:
        包含运行结果和状态的字典
    """
    try:
        # 启动团队运行 - 这模拟一个长任务
        final_response = None
        content_pieces = []

        for chunk in team.run(
            "写一个关于学习编程的龙的非常长的故事。"
            "使其至少 2000 字，包含详细描述和对话。"
            "慢慢来，要非常详尽。",
            stream=True,
        ):
            if "run_id" not in run_id_container and chunk.run_id:
                print(f"团队运行已启动: {chunk.run_id}")
                run_id_container["run_id"] = chunk.run_id

            if chunk.event in [TeamRunEvent.run_content, RunEvent.run_content]:
                print(chunk.content, end="", flush=True)
                content_pieces.append(chunk.content)
            elif chunk.event == RunEvent.run_cancelled:
                print(f"\n成员运行被取消: {chunk.run_id}")
                run_id_container["result"] = {
                    "status": "cancelled",
                    "run_id": chunk.run_id,
                    "cancelled": True,
                    "content": "".join(content_pieces)[:200] + "..."
                    if content_pieces
                    else "取消前无内容",
                }
                return
            elif chunk.event == TeamRunEvent.run_cancelled:
                print(f"\n团队运行被取消: {chunk.run_id}")
                run_id_container["result"] = {
                    "status": "cancelled",
                    "run_id": chunk.run_id,
                    "cancelled": True,
                    "content": "".join(content_pieces)[:200] + "..."
                    if content_pieces
                    else "取消前无内容",
                }
                return
            elif hasattr(chunk, "status") and chunk.status == RunStatus.completed:
                final_response = chunk

        # 如果我们到达这里，运行已成功完成
        if final_response:
            run_id_container["result"] = {
                "status": final_response.status.value
                if final_response.status
                else "completed",
                "run_id": final_response.run_id,
                "cancelled": final_response.status == RunStatus.cancelled,
                "content": ("".join(content_pieces)[:200] + "...")
                if content_pieces
                else "无内容",
            }
        else:
            run_id_container["result"] = {
                "status": "unknown",
                "run_id": run_id_container.get("run_id"),
                "cancelled": False,
                "content": ("".join(content_pieces)[:200] + "...")
                if content_pieces
                else "无内容",
            }

    except Exception as e:
        print(f"\n运行中的异常: {str(e)}")
        run_id_container["result"] = {
            "status": "error",
            "error": str(e),
            "run_id": run_id_container.get("run_id"),
            "cancelled": True,
            "content": "发生错误",
        }


def cancel_after_delay(team: Team, run_id_container: dict, delay_seconds: int = 3):
    """
    在指定延迟后取消团队运行。

    Args:
        team: 应该取消其运行的团队
        run_id_container: 包含要取消的 run_id 的字典
        delay_seconds: 取消前等待多长时间
    """
    print(f"将在 {delay_seconds} 秒后取消团队运行...")
    time.sleep(delay_seconds)

    run_id = run_id_container.get("run_id")
    if run_id:
        print(f"正在取消团队运行: {run_id}")
        success = team.cancel_run(run_id)
        if success:
            print(f"团队运行 {run_id} 已标记为取消")
        else:
            print(
                f"取消团队运行 {run_id} 失败（可能不存在或已完成）"
            )
    else:
        print("未找到要取消的 run_id")


def main():
    """演示团队运行取消的主函数。"""

    # 创建团队成员
    storyteller_agent = Agent(
        name="StorytellerAgent",
        model=OpenAIChat(id="gpt-5-mini"),
        description="一个写创意故事的智能体",
    )

    editor_agent = Agent(
        name="EditorAgent",
        model=OpenAIChat(id="gpt-5-mini"),
        description="一个审查和改进故事的智能体",
    )

    # 使用智能体初始化团队
    team = Team(
        name="Storytelling Team",
        members=[storyteller_agent, editor_agent],
        model=OpenAIChat(id="gpt-5-mini"),  # 团队领导者模型
        description="一个协作写详细故事的团队",
    )

    print("启动团队运行取消示例...")
    print("=" * 50)

    # 在线程间共享 run_id 的容器
    run_id_container = {}

    # 在单独线程中启动团队运行
    team_thread = threading.Thread(
        target=lambda: long_running_task(team, run_id_container), name="TeamRunThread"
    )

    # 启动取消线程
    cancel_thread = threading.Thread(
        target=cancel_after_delay,
        args=(team, run_id_container, 8),  # 8 秒后取消
        name="CancelThread",
    )

    # 启动两个线程
    print("启动团队运行线程...")
    team_thread.start()

    print("启动取消线程...")
    cancel_thread.start()

    # 等待两个线程完成
    print("等待线程完成...")
    team_thread.join()
    cancel_thread.join()

    # 打印结果
    print("\n" + "=" * 50)
    print("结果:")
    print("=" * 50)

    result = run_id_container.get("result")
    if result:
        print(f"状态: {result['status']}")
        print(f"运行 ID: {result['run_id']}")
        print(f"是否被取消: {result['cancelled']}")

        if result.get("error"):
            print(f"错误: {result['error']}")
        else:
            print(f"内容预览: {result['content']}")

        if result["cancelled"]:
            print("\n成功: 团队运行已成功取消！")
        else:
            print("\n警告: 团队运行在取消前已完成")
    else:
        print("未获得结果 - 检查取消是否在流式传输期间发生")

    print("\n团队取消示例完成！")


if __name__ == "__main__":
    # 运行主示例
    main()
```

## API 端点

可以通过 AgentOS API 取消团队运行：

```bash
POST /teams/{team_id}/runs/{run_id}/cancel
```

**示例：**
```bash
curl --location 'http://localhost:7777/teams/storytelling-team/runs/456/cancel' \
  --request POST
```

**参考：**[取消团队运行 API](/reference-api/schema/teams/cancel-team-run)