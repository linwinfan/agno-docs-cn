---
title: "è‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸ"
description: "è‡ªå®šä¹‰æ‚¨çš„ AgentOS åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä»¥å¤„ç†å¯åŠ¨å’Œå…³é—­é€»è¾‘"
keywords: [agentos, agentos é’©å­, ç”Ÿå‘½å‘¨æœŸ, ç”Ÿå‘½å‘¨æœŸå‡½æ•°, ç”Ÿå‘½å‘¨æœŸä¸Šä¸‹æ–‡ç®¡ç†å™¨, fastapi ç”Ÿå‘½å‘¨æœŸ]
---

æ‚¨é€šå¸¸å¸Œæœ›åœ¨ AgentOS åº”ç”¨ç¨‹åºå¯åŠ¨ä¹‹å‰æˆ–å…³é—­ä¹‹å‰è¿è¡Œä»£ç ã€‚

è¿™å¯ä»¥é€šè¿‡ `lifespan` å‚æ•°æä¾›è‡ªå®šä¹‰**ç”Ÿå‘½å‘¨æœŸå‡½æ•°**æ¥å®ç°ã€‚

ç”Ÿå‘½å‘¨æœŸå‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š

```python
@asynccontextmanager
async def lifespan(app):
    # è¿™å°†åœ¨æ‚¨çš„åº”ç”¨ç¨‹åºå¯åŠ¨ä¹‹å‰è¿è¡Œ
    log_info("å¯åŠ¨æˆ‘çš„ FastAPI åº”ç”¨ç¨‹åº")

    yield

    # è¿™å°†åœ¨æ‚¨çš„åº”ç”¨ç¨‹åºå…³é—­ä¹‹å‰è¿è¡Œ
    log_info("åœæ­¢æˆ‘çš„ FastAPI åº”ç”¨ç¨‹åº")
```

## FastAPI ç”Ÿå‘½å‘¨æœŸ

æ‚¨æä¾›çš„è‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸå‡½æ•°å°†è¢«ç”¨ä½œ AgentOS ä½¿ç”¨çš„ FastAPI åº”ç”¨ç¨‹åºçš„**ç”Ÿå‘½å‘¨æœŸä¸Šä¸‹æ–‡ç®¡ç†å™¨**ã€‚è¯·è®°ä½ä½¿ç”¨ `@asynccontextmanager` è£…é¥°å®ƒï¼Œå¦‚ç¤ºä¾‹ä¸­æ‰€ç¤ºã€‚

<Tip>
æŸ¥çœ‹ [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/advanced/events/#lifespan-events) äº†è§£æœ‰å…³ç”Ÿå‘½å‘¨æœŸä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„æ›´å¤šä¿¡æ¯ã€‚
</Tip>

å¦‚æœæ‚¨ä½¿ç”¨è‡ªå®šä¹‰ FastAPI åº”ç”¨ç¨‹åºï¼Œæ— éœ€æ‹…å¿ƒè¦†ç›–å…¶ç”Ÿå‘½å‘¨æœŸã€‚

æ‚¨æä¾›çš„ç”Ÿå‘½å‘¨æœŸå°†åŒ…è£…åº”ç”¨ç¨‹åºçš„ç°æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œè®©æ‚¨å¯ä»¥ç»„åˆæ‰€æœ‰åŠŸèƒ½ã€‚

## å¸¸è§ç”¨ä¾‹

ç”Ÿå‘½å‘¨æœŸæ§åˆ¶å¯¹äºå¤„ç†å…¸å‹çš„å¯åŠ¨å’Œå…³é—­ä»»åŠ¡å¾ˆæœ‰ç”¨ï¼Œä¾‹å¦‚ï¼š

- **èµ„æºåˆå§‹åŒ–**: æ•°æ®åº“ã€ç¬¬ä¸‰æ–¹æœåŠ¡ã€ç¼“å­˜...æˆ–æ‚¨çš„åº”ç”¨ç¨‹åºéœ€è¦çš„ä»»ä½•å…¶ä»–ä¸œè¥¿ã€‚
- **æ¸…ç†**: åœ¨å…³é—­ä¹‹å‰å…³é—­è¿æ¥ã€å­˜å‚¨æ•°æ®æˆ–é‡Šæ”¾èµ„æºã€‚
- **å¥åº·æ£€æŸ¥**: åœ¨æä¾›è¯·æ±‚ä¹‹å‰éªŒè¯ä¾èµ–é¡¹æ˜¯å¦å¯ç”¨
- **åå°ä»»åŠ¡**: å¯åŠ¨/åœæ­¢åå°è¿›ç¨‹

## ç¤ºä¾‹

<Steps>
  <Step title="ä»£ç ">

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¸¦æœ‰è‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸçš„å®Œæ•´ AgentOS ç¤ºä¾‹ï¼š

```python
import asyncio
import logging
from contextlib import asynccontextmanager
from agno.os import AgentOS
from agno.agent import Agent
from agno.models.openai import OpenAIChat

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# è‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸå‡½æ•°
@asynccontextmanager
async def custom_lifespan(app):
    # å¯åŠ¨é€»è¾‘
    logger.info("ğŸš€ æ­£åœ¨å¯åŠ¨ AgentOS åº”ç”¨ç¨‹åº...")
    
    # åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
    logger.info("ğŸ“Š æ­£åœ¨è¿æ¥æ•°æ®åº“...")
    await initialize_database()
    
    # å¯åŠ¨åå°ä»»åŠ¡
    logger.info("âš™ï¸ æ­£åœ¨å¯åŠ¨åå°ä»»åŠ¡...")
    background_task = asyncio.create_task(background_monitor())
    
    # éªŒè¯å¤–éƒ¨æœåŠ¡
    logger.info("ğŸ” æ­£åœ¨éªŒè¯å¤–éƒ¨æœåŠ¡...")
    await verify_external_services()
    
    logger.info("âœ… AgentOS åº”ç”¨ç¨‹åºå¯åŠ¨å®Œæˆ!")
    
    yield
    
    # å…³é—­é€»è¾‘
    logger.info("ğŸ›‘ æ­£åœ¨å…³é—­ AgentOS åº”ç”¨ç¨‹åº...")
    
    # åœæ­¢åå°ä»»åŠ¡
    logger.info("â¹ï¸ æ­£åœ¨åœæ­¢åå°ä»»åŠ¡...")
    background_task.cancel()
    try:
        await background_task
    except asyncio.CancelledError:
        pass
    
    # æ¸…ç†æ•°æ®åº“è¿æ¥
    logger.info("ğŸ“Š æ­£åœ¨å…³é—­æ•°æ®åº“è¿æ¥...")
    await cleanup_database()
    
    # ä¿å­˜åº”ç”¨ç¨‹åºçŠ¶æ€
    logger.info("ğŸ’¾ æ­£åœ¨ä¿å­˜åº”ç”¨ç¨‹åºçŠ¶æ€...")
    await save_application_state()
    
    logger.info("âœ… AgentOS åº”ç”¨ç¨‹åºå…³é—­å®Œæˆ!")

# è¾…åŠ©å‡½æ•°
async def initialize_database():
    """åˆå§‹åŒ–æ•°æ®åº“è¿æ¥"""
    await asyncio.sleep(1)  # æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥
    logger.info("   âœ… æ•°æ®åº“è¿æ¥å·²å»ºç«‹")

async def cleanup_database():
    """æ¸…ç†æ•°æ®åº“è¿æ¥"""
    await asyncio.sleep(0.5)  # æ¨¡æ‹Ÿæ¸…ç†
    logger.info("   âœ… æ•°æ®åº“è¿æ¥å·²å…³é—­")

async def verify_external_services():
    """éªŒè¯å¤–éƒ¨æœåŠ¡å¯ç”¨æ€§"""
    services = ["OpenAI API", "Redis", "å‘é‡æ•°æ®åº“"]
    for service in services:
        await asyncio.sleep(0.3)  # æ¨¡æ‹ŸéªŒè¯
        logger.info(f"   âœ… {service} éªŒè¯é€šè¿‡")

async def background_monitor():
    """åå°ç›‘æ§ä»»åŠ¡"""
    while True:
        try:
            await asyncio.sleep(30)  # æ¯ 30 ç§’è¿è¡Œä¸€æ¬¡
            logger.info("ğŸ”” åå°ç›‘æ§æ£€æŸ¥å®Œæˆ")
        except asyncio.CancelledError:
            logger.info("ğŸ”” åå°ç›‘æ§ä»»åŠ¡å·²åœæ­¢")
            break

async def save_application_state():
    """ä¿å­˜åº”ç”¨ç¨‹åºçŠ¶æ€"""
    await asyncio.sleep(0.5)  # æ¨¡æ‹Ÿä¿å­˜
    logger.info("   âœ… åº”ç”¨ç¨‹åºçŠ¶æ€å·²ä¿å­˜")

# åˆ›å»ºæ™ºèƒ½ä½“
agent = Agent(
    name="ç”Ÿå‘½å‘¨æœŸåŠ©æ‰‹",
    model=OpenAIChat(model="gpt-4o"),
    instructions="æ‚¨æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹ï¼Œäº†è§£ AgentOS ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚"
)

# åˆ›å»ºå¸¦æœ‰è‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸçš„ AgentOS
agent_os = AgentOS(
    name="ç”Ÿå‘½å‘¨æœŸæ¼”ç¤º",
    description="æ¼”ç¤ºè‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸåŠŸèƒ½çš„ AgentOS",
    agents=[agent],
    lifespan=custom_lifespan  # è®¾ç½®è‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸ
)

if __name__ == "__main__":
    # å¯åŠ¨åº”ç”¨ç¨‹åº
    app = agent_os.get_app()
    agent_os.serve(app="lifespan_demo:app", reload=True)
```

  </Step>
  <Step title="è¿è¡Œåº”ç”¨ç¨‹åº">

ä¿å­˜ä»£ç ä¸º `lifespan_demo.py` å¹¶è¿è¡Œï¼š

```bash
python lifespan_demo.py
```

æ‚¨å°†çœ‹åˆ°è¯¦ç»†çš„å¯åŠ¨å’Œå…³é—­æ—¥å¿—ï¼š

```
INFO:__main__:ğŸš€ æ­£åœ¨å¯åŠ¨ AgentOS åº”ç”¨ç¨‹åº...
INFO:__main__:ğŸ“Š æ­£åœ¨è¿æ¥æ•°æ®åº“...
INFO:__main__:   âœ… æ•°æ®åº“è¿æ¥å·²å»ºç«‹
INFO:__main__:âš™ï¸ æ­£åœ¨å¯åŠ¨åå°ä»»åŠ¡...
INFO:__main__:ğŸ” æ­£åœ¨éªŒè¯å¤–éƒ¨æœåŠ¡...
INFO:__main__:   âœ… OpenAI API éªŒè¯é€šè¿‡
INFO:__main__:   âœ… Redis éªŒè¯é€šè¿‡
INFO:__main__:   âœ… å‘é‡æ•°æ®åº“éªŒè¯é€šè¿‡
INFO:__main__:âœ… AgentOS åº”ç”¨ç¨‹åºå¯åŠ¨å®Œæˆ!
INFO:     Started server process [12345]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

å½“æ‚¨æŒ‰ `Ctrl+C` åœæ­¢åº”ç”¨ç¨‹åºæ—¶ï¼Œæ‚¨å°†çœ‹åˆ°å…³é—­æ—¥å¿—ï¼š

```
INFO:     Shutting down
INFO:__main__:ğŸ›‘ æ­£åœ¨å…³é—­ AgentOS åº”ç”¨ç¨‹åº...
INFO:__main__:â¹ï¸ æ­£åœ¨åœæ­¢åå°ä»»åŠ¡...
INFO:__main__:ğŸ”” åå°ç›‘æ§ä»»åŠ¡å·²åœæ­¢
INFO:__main__:ğŸ“Š æ­£åœ¨å…³é—­æ•°æ®åº“è¿æ¥...
INFO:__main__:   âœ… æ•°æ®åº“è¿æ¥å·²å…³é—­
INFO:__main__:ğŸ’¾ æ­£åœ¨ä¿å­˜åº”ç”¨ç¨‹åºçŠ¶æ€...
INFO:__main__:   âœ… åº”ç”¨ç¨‹åºçŠ¶æ€å·²ä¿å­˜
INFO:__main__:âœ… AgentOS åº”ç”¨ç¨‹åºå…³é—­å®Œæˆ!
```

  </Step>
</Steps>

## é«˜çº§ç”¨æ³•

### æ¡ä»¶æ€§å¯åŠ¨

æ ¹æ®ç¯å¢ƒæ¡ä»¶æ‰§è¡Œä¸åŒçš„å¯åŠ¨é€»è¾‘ï¼š

```python
@asynccontextmanager
async def conditional_lifespan(app):
    environment = os.getenv("ENVIRONMENT", "development")
    
    if environment == "production":
        logger.info("ğŸ­ ç”Ÿäº§ç¯å¢ƒå¯åŠ¨")
        await setup_production_resources()
    elif environment == "staging":
        logger.info("ğŸ§ª æµ‹è¯•ç¯å¢ƒå¯åŠ¨")
        await setup_staging_resources()
    else:
        logger.info("ğŸ’» å¼€å‘ç¯å¢ƒå¯åŠ¨")
        await setup_development_resources()
    
    yield
    
    if environment == "production":
        await cleanup_production_resources()
    elif environment == "staging":
        await cleanup_staging_resources()
    else:
        await cleanup_development_resources()
```

### é”™è¯¯å¤„ç†

åœ¨ç”Ÿå‘½å‘¨æœŸä¸­å¤„ç†å¯åŠ¨å’Œå…³é—­é”™è¯¯ï¼š

```python
@asynccontextmanager
async def robust_lifespan(app):
    startup_errors = []
    
    # å¯åŠ¨é˜¶æ®µ
    try:
        await initialize_critical_service()
        logger.info("âœ… å…³é”®æœåŠ¡åˆå§‹åŒ–æˆåŠŸ")
    except Exception as e:
        logger.error(f"âŒ å…³é”®æœåŠ¡åˆå§‹åŒ–å¤±è´¥: {e}")
        startup_errors.append("critical_service")
    
    try:
        await initialize_optional_service()
        logger.info("âœ… å¯é€‰æœåŠ¡åˆå§‹åŒ–æˆåŠŸ")
    except Exception as e:
        logger.warning(f"âš ï¸ å¯é€‰æœåŠ¡åˆå§‹åŒ–å¤±è´¥: {e}")
        # å¯é€‰æœåŠ¡å¤±è´¥ä¸åº”é˜»æ­¢å¯åŠ¨
    
    if "critical_service" in startup_errors:
        logger.error("ğŸš¨ å…³é”®æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œåº”ç”¨ç¨‹åºæ— æ³•å¯åŠ¨")
        raise RuntimeError("å…³é”®æœåŠ¡åˆå§‹åŒ–å¤±è´¥")
    
    yield
    
    # å…³é—­é˜¶æ®µ
    try:
        await cleanup_critical_service()
        logger.info("âœ… å…³é”®æœåŠ¡æ¸…ç†æˆåŠŸ")
    except Exception as e:
        logger.error(f"âŒ å…³é”®æœåŠ¡æ¸…ç†å¤±è´¥: {e}")
    
    try:
        await cleanup_optional_service()
        logger.info("âœ… å¯é€‰æœåŠ¡æ¸…ç†æˆåŠŸ")
    except Exception as e:
        logger.warning(f"âš ï¸ å¯é€‰æœåŠ¡æ¸…ç†å¤±è´¥: {e}")
```

### èµ„æºæ± ç®¡ç†

ç®¡ç†è¿æ¥æ± å’Œå…¶ä»–èµ„æºï¼š

```python
@asynccontextmanager
async def resource_pool_lifespan(app):
    # åˆå§‹åŒ–èµ„æºæ± 
    db_pool = await create_database_pool(max_size=20)
    redis_pool = await create_redis_pool(max_size=10)
    http_client = create_http_client()
    
    # å°†èµ„æºæ·»åŠ åˆ°åº”ç”¨ç¨‹åºçŠ¶æ€
    app.state.db_pool = db_pool
    app.state.redis_pool = redis_pool
    app.state.http_client = http_client
    
    logger.info("ğŸŠ èµ„æºæ± åˆå§‹åŒ–å®Œæˆ")
    
    yield
    
    # æ¸…ç†èµ„æºæ± 
    await db_pool.close()
    await redis_pool.close()
    await http_client.aclose()
    
    logger.info("ğŸŠ èµ„æºæ± æ¸…ç†å®Œæˆ")

async def create_database_pool(max_size: int):
    """åˆ›å»ºæ•°æ®åº“è¿æ¥æ± """
    # å®ç°æ•°æ®åº“è¿æ¥æ± åˆ›å»ºé€»è¾‘
    pass

async def create_redis_pool(max_size: int):
    """åˆ›å»º Redis è¿æ¥æ± """
    # å®ç° Redis è¿æ¥æ± åˆ›å»ºé€»è¾‘
    pass

def create_http_client():
    """åˆ›å»º HTTP å®¢æˆ·ç«¯"""
    # å®ç° HTTP å®¢æˆ·ç«¯åˆ›å»ºé€»è¾‘
    pass
```

### å¥åº·æ£€æŸ¥é›†æˆ

é›†æˆå¥åº·æ£€æŸ¥åˆ°ç”Ÿå‘½å‘¨æœŸï¼š

```python
@asynccontextmanager
async def health_check_lifespan(app):
    health_status = {
        "database": False,
        "redis": False,
        "external_api": False
    }
    
    # å¯åŠ¨å¥åº·æ£€æŸ¥
    async def run_health_checks():
        while True:
            try:
                # æ£€æŸ¥æ•°æ®åº“
                health_status["database"] = await check_database_health()
                
                # æ£€æŸ¥ Redis
                health_status["redis"] = await check_redis_health()
                
                # æ£€æŸ¥å¤–éƒ¨ API
                health_status["external_api"] = await check_external_api_health()
                
                # æ›´æ–°åº”ç”¨ç¨‹åºçŠ¶æ€
                app.state.health_status = health_status
                
                await asyncio.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
            except asyncio.CancelledError:
                break
    
    health_check_task = asyncio.create_task(run_health_checks())
    
    # æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹
    @app.get("/health")
    async def health_endpoint():
        return {"status": "healthy", "checks": health_status}
    
    yield
    
    health_check_task.cancel()
    try:
        await health_check_task
    except asyncio.CancelledError:
        pass

async def check_database_health():
    """æ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€"""
    try:
        # å®ç°æ•°æ®åº“å¥åº·æ£€æŸ¥
        return True
    except:
        return False

async def check_redis_health():
    """æ£€æŸ¥ Redis å¥åº·çŠ¶æ€"""
    try:
        # å®ç° Redis å¥åº·æ£€æŸ¥
        return True
    except:
        return False

async def check_external_api_health():
    """æ£€æŸ¥å¤–éƒ¨ API å¥åº·çŠ¶æ€"""
    try:
        # å®ç°å¤–éƒ¨ API å¥åº·æ£€æŸ¥
        return True
    except:
        return False
```

## æœ€ä½³å®è·µ

### 1. å¹‚ç­‰æ€§

ç¡®ä¿å¯åŠ¨å’Œå…³é—­æ“ä½œæ˜¯å¹‚ç­‰çš„ï¼š

```python
@asynccontextmanager
async def idempotent_lifespan(app):
    # ä½¿ç”¨çŠ¶æ€æ ‡å¿—é¿å…é‡å¤åˆå§‹åŒ–
    if not hasattr(app.state, "initialized"):
        await initialize_resources()
        app.state.initialized = True
    
    yield
    
    if hasattr(app.state, "initialized"):
        await cleanup_resources()
        delattr(app.state, "initialized")
```

### 2. è¶…æ—¶æ§åˆ¶

ä¸ºå¯åŠ¨å’Œå…³é—­æ“ä½œè®¾ç½®è¶…æ—¶ï¼š

```python
@asynccontextmanager
async def timeout_lifespan(app):
    try:
        # è®¾ç½®å¯åŠ¨è¶…æ—¶
        await asyncio.wait_for(initialize_resources(), timeout=30)
        logger.info("âœ… èµ„æºåˆå§‹åŒ–æˆåŠŸ")
    except asyncio.TimeoutError:
        logger.error("âŒ èµ„æºåˆå§‹åŒ–è¶…æ—¶")
        raise
    
    yield
    
    try:
        # è®¾ç½®å…³é—­è¶…æ—¶
        await asyncio.wait_for(cleanup_resources(), timeout=10)
        logger.info("âœ… èµ„æºæ¸…ç†æˆåŠŸ")
    except asyncio.TimeoutError:
        logger.error("âŒ èµ„æºæ¸…ç†è¶…æ—¶")
```

### 3. ä¼˜é›…å…³é—­

å®ç°ä¼˜é›…å…³é—­æœºåˆ¶ï¼š

```python
@asynccontextmanager
async def graceful_lifespan(app):
    shutdown_event = asyncio.Event()
    
    # è®¾ç½®ä¿¡å·å¤„ç†å™¨
    def signal_handler(signum, frame):
        logger.info(f"æ”¶åˆ°ä¿¡å· {signum}ï¼Œå¼€å§‹ä¼˜é›…å…³é—­...")
        shutdown_event.set()
    
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    yield
    
    # ç­‰å¾…å…³é—­ä¿¡å·æˆ–è¶…æ—¶
    try:
        await asyncio.wait_for(shutdown_event.wait(), timeout=30)
    except asyncio.TimeoutError:
        logger.warning("â° ä¼˜é›…å…³é—­è¶…æ—¶ï¼Œå¼ºåˆ¶é€€å‡º")
    
    await cleanup_resources()
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. ç”Ÿå‘½å‘¨æœŸå‡½æ•°æœªæ‰§è¡Œ

ç¡®ä¿æ­£ç¡®ä½¿ç”¨ `@asynccontextmanager` è£…é¥°å™¨ï¼š

```python
# âŒ é”™è¯¯ï¼šç¼ºå°‘è£…é¥°å™¨
async def lifespan(app):
    # ä»£ç 
    yield
    # æ›´å¤šä»£ç 

# âœ… æ­£ç¡®ï¼šä½¿ç”¨è£…é¥°å™¨
@asynccontextmanager
async def lifespan(app):
    # ä»£ç 
    yield
    # æ›´å¤šä»£ç 
```

#### 2. å¯åŠ¨å¤±è´¥æ—¶èµ„æºæ³„æ¼

åœ¨å¯åŠ¨å¤±è´¥æ—¶æ­£ç¡®æ¸…ç†èµ„æºï¼š

```python
@asynccontextmanager
async def safe_lifespan(app):
    resources = []
    
    try:
        resource1 = await create_resource1()
        resources.append(resource1)
        
        resource2 = await create_resource2()
        resources.append(resource2)
        
        yield
    except Exception as e:
        logger.error(f"å¯åŠ¨å¤±è´¥: {e}")
    finally:
        # æ¸…ç†æ‰€æœ‰å·²åˆ›å»ºçš„èµ„æº
        for resource in reversed(resources):
            try:
                await cleanup_resource(resource)
            except Exception as e:
                logger.error(f"èµ„æºæ¸…ç†å¤±è´¥: {e}")
```

#### 3. å…³é—­é¡ºåºé—®é¢˜

æŒ‰æ­£ç¡®é¡ºåºæ¸…ç†èµ„æºï¼š

```python
@asynccontextmanager
async def ordered_lifespan(app):
    # æŒ‰ä¾èµ–é¡ºåºåˆå§‹åŒ–
    db_connection = await create_db_connection()
    cache_client = await create_cache_client(db_connection)
    api_service = await create_api_service(cache_client)
    
    yield
    
    # æŒ‰ç›¸åé¡ºåºæ¸…ç†
    await cleanup_api_service(api_service)
    await cleanup_cache_client(cache_client)
    await cleanup_db_connection(db_connection)
```

## ä¸‹ä¸€æ­¥

- äº†è§£[AgentOS é…ç½®](/agent-os/config)é€‰é¡¹
- æŸ¥çœ‹[åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ª OS](/agent-os/creating-your-first-os)äº†è§£åŸºæœ¬è®¾ç½®
- æ¢ç´¢[æ§åˆ¶å¹³é¢åŠŸèƒ½](/agent-os/control-plane)
- æŸ¥çœ‹[éƒ¨ç½²æŒ‡å—](/deploy/overview)äº†è§£ç”Ÿäº§éƒ¨ç½²

## ç›¸å…³èµ„æº

- [FastAPI ç”Ÿå‘½å‘¨æœŸæ–‡æ¡£](https://fastapi.tiangolo.com/advanced/events/#lifespan-events)
- [Python ä¸Šä¸‹æ–‡ç®¡ç†å™¨](https://docs.python.org/3/library/contextlib.html)
- [asyncio äº‹ä»¶å¾ªç¯](https://docs.python.org/3/library/asyncio-eventloop.html)