---
title: 智能体会话
---

本示例展示如何创建具有存储在 SQLite 数据库中持久化内存的智能体。我们在恢复对话时在智能体上设置 session_id，这样之前的聊天历史就被保留下来。

关键功能：
- 在 SQLite 数据库中存储对话历史
- 在多个会话间继续对话
- 在响应中引用之前的上下文

## 代码

```python agent_session.py
import json
from typing import List, Optional

import typer
from agno.agent import Agent
from agno.db.base import SessionType
from agno.db.sqlite import SqliteDb
from agno.models.openai import OpenAIChat
from agno.session import AgentSession
from rich import print
from rich.console import Console
from rich.json import JSON
from rich.panel import Panel
from rich.prompt import Prompt

console = Console()


def create_agent(user: str = "user"):
    session_id: Optional[str] = None

    # 询问用户是否要开始新会话或继续现有会话
    new = typer.confirm("您想开始新会话吗？")

    # 如果用户不想开始新会话，则获取现有会话
    db = SqliteDb(db_file="tmp/agents.db")

    if not new:
        existing_sessions: List[AgentSession] = db.get_sessions(
            user_id=user, session_type=SessionType.AGENT
        )  # type: ignore
        if len(existing_sessions) > 0:
            session_id = existing_sessions[0].session_id

    agent = Agent(
        user_id=user,
        # 在智能体上设置 session_id 以恢复对话
        session_id=session_id,
        model=OpenAIChat(id="gpt-5-mini"),
        db=db,
        # 将聊天历史添加到消息中
        add_history_to_context=True,
        num_history_runs=3,
        markdown=True,
    )

    if session_id is None:
        session_id = agent.session_id
        if session_id is not None:
            print(f"开始会话：{session_id}\n")
        else:
            print("开始会话\n")
    else:
        print(f"继续会话：{session_id}\n")

    return agent


def print_messages(agent):
    """在格式化面板中打印当前聊天历史"""
    console.print(
        Panel(
            JSON(
                json.dumps(
                    [
                        m.model_dump(include={"role", "content"})
                        for m in agent.get_session_messages()
                    ]
                ),
                indent=4,
            ),
            title=f"会话 ID {agent.session_id} 的聊天历史",
            expand=True,
        )
    )


def main(user: str = "user"):
    agent = create_agent(user)

    print("与 OpenAI 智能体聊天！")
    exit_on = ["exit", "quit", "bye"]
    while True:
        message = Prompt.ask(f"[bold] :sunglasses: {user} [/bold]")
        if message in exit_on:
            break

        agent.print_response(input=message, stream=True, markdown=True)
        print_messages(agent)


if __name__ == "__main__":
    typer.run(main)
```

## 使用方法

<Steps>
  <Snippet file="create-venv-step.mdx" />

  <Step title="安装库">
    ```bash
    pip install openai sqlalchemy agno
    ```
  </Step>

  <Step title="运行智能体">
    ```bash
    python agent_session.py
    ```
  </Step>

</Steps>