---
title: 带存储的智能体
sidebarTitle: 带存储的智能体
description: 学习如何创建具有持久化存储的智能体
mode: wide
---

本示例展示如何创建一个 AI 烹饪助手，它结合了精选食谱数据库的知识、网络搜索功能和持久化存储。智能体使用正宗泰国食谱的 PDF 知识库，并可以在需要时通过网络搜索补充这些信息。

尝试的示例提示：
- "如何制作正宗的泰式炒河粉？"
- "红咖喱和绿咖喱有什么区别？"
- "你能解释什么是高良姜以及可能的替代品吗？"
- "告诉我冬阴功汤的历史"
- "泰式厨房必备的食材有哪些？"
- "如何制作泰式罗勒鸡（泰式炒鸡）？"

## 代码

```python agent_with_storage.py
from textwrap import dedent
from typing import List, Optional

import typer
from agno.agent import Agent
from agno.db.base import SessionType
from agno.db.sqlite import SqliteDb
from agno.knowledge.embedder.openai import OpenAIEmbedder
from agno.knowledge.knowledge import Knowledge
from agno.models.openai import OpenAIChat
from agno.session import AgentSession
from agno.tools.duckduckgo import DuckDuckGoTools
from agno.vectordb.lancedb import LanceDb, SearchType
from rich import print

agent_knowledge = Knowledge(
    vector_db=LanceDb(
        uri="tmp/lancedb",
        table_name="recipe_knowledge",
        search_type=SearchType.hybrid,
        embedder=OpenAIEmbedder(id="text-embedding-3-small"),
    ),
)

# Add content to the knowledge
agent_knowledge.add_content(
    url="https://agno-public.s3.amazonaws.com/recipes/ThaiRecipes.pdf"
)

# Setup the database
db = SqliteDb(db_file="tmp/agents.db")


def recipe_agent(user: str = "user"):
    session_id: Optional[str] = None

    # 询问用户是否要开始新会话或继续现有会话
    new = typer.confirm("您想开始新会话吗？")

    if not new:
        existing_sessions: List[AgentSession] = db.get_sessions(  # type: ignore
            user_id=user, session_type=SessionType.AGENT
        )
        if len(existing_sessions) > 0:
            session_id = existing_sessions[0].session_id

    agent = Agent(
        user_id=user,
        session_id=session_id,
        model=OpenAIChat(id="gpt-5-mini"),
        instructions=dedent("""\
            你是一位充满热情且知识渊博的泰国美食专家！🧑‍🍳
            把自己想象成一个温暖、鼓励的烹饪指导、
            泰国美食史学家和文化大使的结合体。

            回答问题时遵循以下步骤：
            1. 首先，在知识库中搜索正宗的泰国食谱和烹饪信息
            2. 如果知识库中的信息不完整或者用户提出的问题更适合网络搜索，则通过网络搜索填补空白
            3. 如果在知识库中找到信息，则无需搜索网络
            4. 为了真实性，始终优先考虑知识库信息而不是网络结果
            5. 如果需要，通过网络搜索补充：
               - 现代改编或食材替代品
               - 文化背景和历史背景
               - 额外的烹饪技巧和故障排除

            沟通风格：
            1. 每个回应以相关的烹饪表情符号开始
            2. 清晰地构建你的回应：
               - 简短的介绍或背景
               - 主要内容（食谱、解释或历史）
               - 专业技巧或文化见解
               - 鼓励性的结论
            3. 对于食谱，包括：
               - 食材清单及可能的替代品
               - 清晰的编号烹饪步骤
               - 成功技巧和常见陷阱
            4. 使用友好、鼓励的语言

            特殊功能：
            - 解释不熟悉的泰国食材并建议替代品
            - 分享相关的文化背景和传统
            - 为适应不同饮食需求提供食谱改编技巧
            - 包括上菜建议和配菜

            每个回应以振奋人心的署名结束，例如：
            - '快乐烹饪！ขอให้อร่อย (享用您的餐点)！'
            - '愿您的泰国烹饪冒险带来快乐！'
            - '享用您的自制泰国盛宴！'

            记住：
            - 始终通过知识库验证食谱真实性
            - 明确指出信息来自网络来源时的时间
            - 鼓励并支持所有技能水平的家庭厨师\
        """),
        db=db,
        knowledge=agent_knowledge,
        tools=[DuckDuckGoTools()],
        # 为智能体提供聊天历史
        # 我们可以：
        # 1. 为智能体提供读取聊天历史的工具
        # 2. 自动将聊天历史添加到发送给模型的消息中
        #
        # 1. 为智能体提供读取聊天历史的工具
        read_chat_history=True,
        # 2. 自动将聊天历史添加到发送给模型的消息中
        # add_history_to_context=True,
        # 要添加到消息的历史响应数量。
        # num_history_runs=3,
        markdown=True,
    )

    print("您即将与智能体聊天！")
    if session_id is None:
        session_id = agent.session_id
        if session_id is not None:
            print(f"开始会话：{session_id}\n")
        else:
            print("开始会话\n")
    else:
        print(f"继续会话：{session_id}\n")

    # 将智能体作为命令行应用程序运行
    agent.cli_app(markdown=True)


if __name__ == "__main__":
    typer.run(recipe_agent)
```

## 使用方法

<Steps>
  <Snippet file="create-venv-step.mdx" />

  <Step title="安装库">
    ```bash
    pip install openai lancedb tantivy pypdf ddgs sqlalchemy agno
    ```
  </Step>

  <Step title="运行智能体">
    ```bash
    python agent_with_storage.py
    ```
  </Step>

</Steps>